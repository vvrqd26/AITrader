# AI 交易员

这是一个基于大模型的实验性量化交易软件,用于验证 AI Agent 自主交易的可行性。系统通过模拟交易数字货币合约,测试大模型在真实市场环境下的决策能力。

**重要提示**: 这是实验项目,当前仅支持模拟交易,不涉及真实资金。

## 系统架构

系统由三个核心模块组成:

### 1. 合约交易执行器 (模拟盘)

负责执行所有交易操作,模拟真实交易环境:

**交易功能**:
- 开仓: 支持做多/做空,可使用杠杆
- 平仓: 支持部分平仓和全部平仓
- 止损止盈: 开仓时必须同时设置止损和止盈价格
- 动态调整: 支持修改已有仓位的止损止盈价格

**交易计划**:
- 创建计划: 设置触发价格,到达时自动开仓
- 管理计划: 支持修改和删除待触发的计划
- 自动执行: 实时监控价格,触发条件时自动执行

**模拟交易细节**:
- 初始资金: 100,000 USD (可配置)
- 交易手续费: 0.01% (可配置)
- 滑点模拟: 按市价成交
- 爆仓处理: 当亏损超过保证金时强制平仓
- 保证金计算: 根据杠杆倍数计算占用保证金

**风险硬限制**:
- 单笔最大仓位: 30% 总资金 (可配置)
- 最大杠杆倍数: 20 倍 (可配置)
- 强制止损距离: 至少 5% (可配置)

### 2. 信息收集器

从芝麻开门(Gate.io)获取市场数据,并计算技术指标:

**数据获取**:
- 实时价格: 目标交易对的最新成交价
- 历史K线: 多周期 K 线数据(15分钟、1小时、4小时、1日、1周)
- 数据缓存: 本地缓存历史数据,避免重复请求(缓存时长可配置,默认24小时)

**技术指标计算**:
支持多周期计算以下指标:
- 趋势指标: MA(移动平均线)、EMA(指数移动平均)、MACD
- 动量指标: RSI(相对强弱指数)、KDJ
- 波动指标: 布林带(BOLL)、ATR(真实波幅)
- 成交量指标: OBV(能量潮)

**账户状态**:
- 资金信息: 总资金、可用资金、已用保证金、未实现盈亏
- 持仓列表: 每个仓位的开仓价、当前价、盈亏金额、盈亏比例、持仓时长
- 交易计划: 所有待触发的计划及其触发条件

**信息整理**:
将以上信息格式化为结构化数据,传递给 Agent 进行决策。

### 3. AI 交易 Agent

由 DeepSeek 最新大模型驱动,模拟专业交易员的决策过程:

**决策流程**:
1. 接收信息收集器整理的市场数据和账户状态
2. 输出市场分析和交易判断(文本形式)
3. 如需执行交易,输出 JSON 格式的工具调用指令
4. 通过 MCP 协议调用交易执行器完成操作

**Agent 能力**:
- 多维度分析: 综合多个时间周期的指标进行判断(看长做短)
- 仓位管理: 根据市场状况和账户状态决定开仓比例和杠杆倍数
- 风险控制: 每次开仓必须设置合理的止损止盈
- 动态调整: 根据行情变化修改止损止盈(移动止损、扩大止盈)
- 计划管理: 制定分批建仓计划,在关键价位设置触发条件
- 应急处理: 识别行情突变,直接执行紧急平仓

**Agent 交易风格** (可通过 Prompt 配置):
- 交易纪律: 严格止损,不扛单
- 盈亏比: 追求至少 1:2 的风险收益比
- 仓位控制: 建议单笔不超过 20% 总资金
- 择时策略: 趋势跟踪为主,震荡市减少操作

## MCP 工具定义

提供给 Agent 的工具清单 (通过 MCP 协议调用):

**交易执行类**:
- `open_position`: 开仓
  - 参数: symbol(交易对), direction(多/空), amount(金额), leverage(杠杆), stop_loss(止损价), take_profit(止盈价)
  - 返回: position_id(仓位ID), entry_price(实际成交价)

- `close_position`: 平仓
  - 参数: position_id(仓位ID), ratio(平仓比例, 0-1)
  - 返回: closed_amount(平仓金额), realized_pnl(实现盈亏)

- `modify_position`: 修改仓位止损止盈
  - 参数: position_id, stop_loss(新止损价), take_profit(新止盈价)

**交易计划类**:
- `create_plan`: 创建交易计划
  - 参数: trigger_price(触发价格), direction(多/空), amount, leverage, stop_loss, take_profit
  - 返回: plan_id(计划ID)

- `modify_plan`: 修改交易计划
  - 参数: plan_id, trigger_price, amount, leverage, stop_loss, take_profit

- `cancel_plan`: 取消交易计划
  - 参数: plan_id

**查询类**:
- `get_account_info`: 获取账户信息
  - 返回: total_balance(总资金), available(可用资金), margin_used(已用保证金), unrealized_pnl(未实现盈亏)

- `get_positions`: 获取所有持仓
  - 返回: 持仓列表(仓位ID、方向、开仓价、当前价、盈亏、止损、止盈、持仓时长)

- `get_plans`: 获取所有待触发计划
  - 返回: 计划列表(计划ID、触发价、方向、金额、杠杆、止损、止盈)

## 运行流程

### 主循环
```
启动 -> 初始化配置 -> 进入循环
  ├─ 1. 检查交易计划触发条件(独立线程实时监控)
  ├─ 2. 收集市场数据和账户状态
  ├─ 3. 调用 Agent 进行决策
  ├─ 4. 解析 Agent 输出的工具调用(JSON)
  ├─ 5. 执行交易操作(调用 MCP 工具)
  ├─ 6. 记录日志(输入、决策、执行结果)
  └─ 7. 等待下一个循环(默认 60 秒)
```

### 交易计划监控
独立于主循环,实时监控价格并触发计划:
```
独立线程 -> 每秒检查当前价格
  ├─ 遍历所有待触发计划
  ├─ 判断触发条件是否满足
  ├─ 满足条件 -> 执行开仓 -> 删除计划 -> 记录日志
  └─ 不满足 -> 继续监控
```

### 异常处理
- API 调用失败: 记录错误日志,本次循环跳过,下次循环重试
- Agent 输出格式错误: 记录原始输出,跳过执行,继续下次循环
- 网络断开: 暂停循环,每 10 秒重试连接
- 余额不足: 拒绝开仓,记录警告日志

## 配置文件

配置文件格式为 JSON,包含以下字段:

```json
{
  "api_keys": {
    "deepseek": "your-deepseek-api-key",
    "gateio_key": "your-gateio-api-key",
    "gateio_secret": "your-gateio-api-secret"
  },
  
  "trading": {
    "symbol": "BTC_USDT",
    "initial_balance": 100000,
    "fee_rate": 0.0001,
    "max_position_ratio": 0.3,
    "max_leverage": 20,
    "min_stop_loss_percent": 0.05
  },
  
  "indicators": {
    "timeframes": ["15m", "1h", "4h", "1d", "1w"],
    "types": ["MA", "EMA", "MACD", "RSI", "BOLL", "KDJ", "ATR", "OBV"],
    "ma_periods": [5, 10, 20, 60],
    "rsi_period": 14,
    "macd_params": [12, 26, 9]
  },
  
  "cache": {
    "history_ttl": 86400
  },
  
  "loop": {
    "interval": 60,
    "plan_check_interval": 1
  },
  
  "agent": {
    "style": "conservative",
    "system_prompt": "你是一个专业的加密货币交易员..."
  }
}
```

**配置说明**:
- `symbol`: 交易对,格式为 BASE_QUOTE (如 BTC_USDT)
- `initial_balance`: 模拟账户初始资金(USD)
- `fee_rate`: 交易手续费率(0.0001 = 0.01%)
- `max_position_ratio`: 单笔最大仓位占总资金比例(0.3 = 30%)
- `max_leverage`: 最大杠杆倍数
- `min_stop_loss_percent`: 最小止损距离(0.05 = 5%)
- `interval`: 主循环间隔(秒)
- `plan_check_interval`: 交易计划检查间隔(秒)
- `history_ttl`: 历史数据缓存时长(秒)

## 软件面板

Web UI 显示以下信息:

### 1. 账户概览
- 总资金(实时)
- 可用资金
- 已用保证金
- 未实现盈亏
- 账户权益曲线图(折线图,记录每次循环的总资金)

### 2. 持仓管理
表格显示:
- 仓位 ID
- 方向(多/空)
- 开仓价格
- 当前价格
- 持仓金额
- 杠杆倍数
- 盈亏金额
- 盈亏比例
- 止损价格
- 止盈价格
- 持仓时长

### 3. 交易计划
表格显示:
- 计划 ID
- 触发价格
- 方向
- 计划金额
- 杠杆倍数
- 止损价格
- 止盈价格
- 创建时间

### 4. Agent 决策记录
显示最近 50 条决策:
- 时间戳
- 市场分析(Agent 输出的文本判断)
- 决策结果(开仓/平仓/修改/无操作)
- 工具调用(JSON 格式)
- 执行结果(成功/失败/原因)

### 5. 系统状态
- 运行状态(运行中/已暂停/错误)
- 当前循环次数
- 上次决策时间
- API 连接状态(DeepSeek / Gate.io)
- 下次循环倒计时

## 日志系统

日志分为三个级别,记录到文件和控制台:

### 1. 决策日志 (`decision.log`)
每次 Agent 决策记录一条:
```json
{
  "timestamp": "2025-11-26T10:30:00Z",
  "cycle": 123,
  "input": {
    "account": {...},
    "positions": [...],
    "plans": [...],
    "market": {...},
    "indicators": {...}
  },
  "agent_output": {
    "analysis": "当前 BTC 处于上升趋势...",
    "decision": "开多单",
    "tool_call": {...}
  },
  "execution": {
    "success": true,
    "result": {...}
  },
  "duration_ms": 1234
}
```

### 2. 交易日志 (`trades.log`)
每次交易操作记录一条:
```json
{
  "timestamp": "2025-11-26T10:30:05Z",
  "type": "open_position",
  "params": {...},
  "result": {
    "position_id": "pos_001",
    "entry_price": 95000,
    "fee": 9.5
  }
}
```

### 3. 系统日志 (`system.log`)
记录系统运行状态和错误:
```
[2025-11-26 10:30:00] INFO: 系统启动,初始化配置
[2025-11-26 10:30:01] INFO: 连接 Gate.io API 成功
[2025-11-26 10:30:02] ERROR: DeepSeek API 调用失败: timeout
[2025-11-26 10:30:10] WARNING: 账户可用资金不足,拒绝开仓
```

**日志配置**:
- 保留时长: 30 天
- 单文件大小: 100MB (超出后滚动)
- 日志目录: `./logs/`

## 技术栈

- **后端**: Python 3.10+
  - `ccxt`: 对接 Gate.io API
  - `pandas` / `ta-lib`: 技术指标计算
  - `openai`: 调用 DeepSeek API
  - `fastapi`: Web API
  - `asyncio`: 异步处理

- **前端**: 
  - `React` / `Vue`: UI 框架
  - `Chart.js`: 图表展示
  - `WebSocket`: 实时数据更新

- **存储**:
  - `SQLite`: 历史数据和日志持久化
  - `Redis` (可选): 缓存热数据

## 开发计划

### Phase 1: 核心功能
- [ ] 模拟交易执行器
- [ ] Gate.io 数据获取
- [ ] 技术指标计算
- [ ] MCP 工具实现
- [ ] Agent 决策循环

### Phase 2: 完善功能
- [ ] Web 面板
- [ ] 日志系统
- [ ] 配置管理
- [ ] 异常处理

### Phase 3: 优化迭代
- [ ] 根据运行日志优化 Agent Prompt
- [ ] 添加更多技术指标
- [ ] 支持多交易对
- [ ] 策略参数优化